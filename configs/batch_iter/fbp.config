from functools import partial

import numpy as np

from dpipe.batch_iter import Infinite, load_by_random_id, apply_at, random_apply, multiply, combine_pad, Loky
from fbp_aug.batch_iter import extract_slice, symmetry_transform_2d, fbp
from fbp_aug.dataset import normalize_ct


batch_size = 32
batches_per_epoch = 100
seed = 42
non_zero_fraction = 0.0

batch_iter = Infinite(
        load_by_random_id(load_x, load_y, load_sin, ids=ids, random_state=seed),
        partial(extract_slice, non_zero_fraction=non_zero_fraction),
        Loky(fbp, n_workers=8, buffer_size=100),
        random_apply(0.5, symmetry_transform_2d),
        apply_at(0, partial(normalize_ct, min_clip=min_clip, max_clip=max_clip)),
        multiply(np.float32),
        batch_size=batch_size,
        batches_per_epoch=batches_per_epoch,
        combiner=partial(combine_pad, padding_values=np.min),
        buffer_size=batch_size
)
